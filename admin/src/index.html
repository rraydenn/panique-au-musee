<!doctype html>
<html lang="fr">
    <head>
		<meta charset="UTF-8">
        <title>Panique au Musée - Confidentiel</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
        <link rel="stylesheet" href="css/style.css"/>
		<meta name="viewport" content="width=device-width, initial-scale=1">
    <script>
    	function authenticateAdmin() {
    		console.log("TODO...");
    		return true;
    	}
    </script>
    </head>
    <body class="b">
		<header>
			<h1>Panique au Musée</h1>
			<h1 class="elanor">Confidentiel</span></h1>
		</header>

		<section>
			<h2>Page de connexion</h2>
			<div class="content">
				<h1 class="pwd">Réservée à Lorenzo Menicci et ses accolytes.</h1>
				<p><strong>TODO:</strong> mettre en place le script de connexion en tant que fonction de validation du formulaire. Si un token est récupéré dans la réponse, elle renverra <code>true</code> et le changement de page sera déclenché.</p>
				<form onsubmit="return authenticateAdmin();" action="admin.html" class="pure-form">
					<fieldset style="display: flow-root;" class="door">
						<label for="pass" class="first">Mot de passe </label> <input type="password" id="pass">&nbsp;&nbsp;
						<input type="submit" value="&#x1F3A9;" class="iconic">
					</fieldset>
				</form>
			</div>
		</section>
	</body>
</html>

<script>
    async function authenticateAdmin() {
        // Get the password from the form
        const password = document.getElementById("pass").value;
        
        if (!password) {
            alert("Veuillez entrer un mot de passe");
            return false;
        }
        
        try {
            // Send authentication request to Spring Boot server
            const response = await fetch("http://localhost:8080/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Origin": window.location.origin
                },
                body: JSON.stringify({ 
                    login: "admin", 
                    password: password 
                })
            });
            
            if (response.status === 204) {
                // Authentication successful - get the token from header
                const authHeader = response.headers.get("Authorization");
                if (authHeader && authHeader.startsWith("Bearer ")) {
                    // Store the token in localStorage for later use
                    const token = authHeader.substring(7); // Remove 'Bearer ' prefix
                    localStorage.setItem("adminToken", token);
                    console.log("Authentication successful, token stored");
                    return true; // Allow form submission to proceed to admin.html
                }
            }
            
            // Authentication failed
            alert("Authentification échouée. Mot de passe incorrect.");
            return false; // Prevent form submission
            
        } catch (error) {
            console.error("Error during authentication:", error);
            alert("Erreur lors de l'authentification. Vérifiez la console pour plus de détails.");
            return false; // Prevent form submission
        }
    }

    // Vérifier l'authentification et démarrer le polling
    document.addEventListener('DOMContentLoaded', function() {
        if(window.location.pathname.includes('admin.html')) {
            const token = localStorage.getItem('adminToken');
        
            if (!token) {
                // Rediriger vers la page de connexion si non authentifié
                window.location.href = 'index.html';
            } else {
                // Démarrer le polling des ressources si gameService est disponible
                if (window.gameService) {
                    window.gameService.startPolling();
                    console.log('Polling des ressources démarré');
                } else {
                    console.error('GameService non disponible');
                }
            }
        }
        
    });
</script>